<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Login - Cloudflare Auth</title>
    <style>
        body { background: #0a0a0a; color: #e0e0e0; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #1a1a1a; padding: 40px; border-radius: 8px; border: 1px solid #2a2a2a; text-align: center; width: 320px; }
        h2 { margin-bottom: 10px; }
        p { color: #888; font-size: 0.9em; margin-bottom: 20px; }
        button { width: 100%; padding: 12px; background: #4a9eff; border: none; color: white; cursor: pointer; border-radius: 4px; font-size: 16px; }
        button:hover { background: #357abd; }
        .note { margin-top: 20px; font-size: 0.8em; color: #666; }
    </style>
</head>
<body>
    <div class="card">
        <h2>Accedi al Portale</h2>
        <p>Autenticazione sicura tramite Cloudflare Worker</p>
        <button onclick="openLoginPopup()">Accedi con Email</button>
        <div class="note">
            Verrai reindirizzato al portale di login sicuro
        </div>
    </div>

    <script>
        // CONFIGURAZIONE: Inserisci l'URL del tuo Cloudflare Worker
        const WORKER_URL = 'https://login-service.tuo-subdomain.workers.dev';

        function openLoginPopup() {
            const w = 450, h = 550;
            const left = (window.innerWidth / 2) - (w / 2);
            const top = (window.innerHeight / 2) - (h / 2);

            const authWindow = window.open(
                WORKER_URL + '/login',
                'CloudflareAuth',
                `width=${w},height=${h},top=${top},left=${left},resizable=yes,scrollbars=yes`
            );

            const messageHandler = (event) => {
                // In produzione verifica l'origin:
                // const allowedOrigin = new URL(WORKER_URL).origin;
                // if (event.origin !== allowedOrigin) return;

                if (event.data && event.data.type === 'AUTH_SUCCESS') {
                    localStorage.setItem('user_web_id', event.data.user_web_id);
                    localStorage.setItem('auth_token', event.data.token);
                    window.removeEventListener('message', messageHandler);
                    
                    if (authWindow && !authWindow.closed) {
                        authWindow.close();
                    }
                    
                    window.location.replace('index.html');
                }
            };

            window.addEventListener('message', messageHandler);

            // Check se popup Ã¨ stato chiuso manualmente
            const checkClosed = setInterval(() => {
                if (authWindow && authWindow.closed) {
                    clearInterval(checkClosed);
                    window.removeEventListener('message', messageHandler);
                }
            }, 500);
        }
    </script>
</body>
</html>
